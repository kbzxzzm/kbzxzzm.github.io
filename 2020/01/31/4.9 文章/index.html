
<!DOCTYPE html>
<html lang="zh-CN" class="loading">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>文章模型设计 - 浮雨博客</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate">
    <meta name="keywords" content="TriDiamond Obsidian,"> 
    <meta name="description" content="4.9.1 文章模型设计我们只存储文章的作者 id、标题、正文和点击量这几个字段，对应修改 lib/mongo.js，添加如下代码：
lib/mongo.js
1234567exports.Post,"> 
    <meta name="author" content="Floating Rain"> 
    <link rel="alternative" href="atom.xml" title="浮雨博客" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link href="https://fonts.loli.net/css?family=Roboto+Mono|Rubik&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_1429596_nzgqgvnmkjb.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.7.2/animate.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/codemirror.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/theme/dracula.css">
    <link rel="stylesheet" href="/css/obsidian.css">
    <link rel="stylesheet" href="/css/ball-atom.min.css">
</head>
</html>

<body class="loading">
    <div class="loader">
        <div class="la-ball-atom la-2x">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
    <span id="config-title" style="display:none">浮雨博客</span>
    <div id="loader"></div>
    <div id="single">
    <div class="scrollbar gradient-bg-rev"></div>
<div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <div class="navigation animated fadeIn fast delay-1s">
        <img id="home-icon" class="icon-home" src="/img/favicon.png" alt="" data-url="https://kbzxzzm.github.io">
        <div id="play-icon" title="Play/Pause" class="iconfont icon-play"></div>
        <h3 class="subtitle">文章模型设计</h3>
        <div class="social">
            <!--        <div class="like-icon">-->
            <!--            <a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
            <!--        </div>-->
            <div>
                <div class="share">
                    
                        <a href="javascript:;" class="iconfont icon-share1"></a>
                        <div class="share-component-cc" data-disabled="facebook,douban,linkedin,diandian,tencent,google"></div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="section">
        <div class=article-header-wrapper>
    <div class="article-header">
        <div class="article-cover animated fadeIn" style="
            animation-delay: 600ms;
            animation-duration: 1.2s;
            background-image: 
                radial-gradient(ellipse closest-side, rgba(0, 0, 0, 0.65), #100e17),
                url(/img/cover.jpg);">
        </div>
        <div class="else">
            <p class="animated fadeInDown">
                
                <a href="javascript:;"><b>「 </b>文章<b> 」</b></a>
                
                一月 31, 2020
            </p>
            <h3 class="post-title animated fadeInDown"><a href="/2020/01/31/4.9 文章/" title="文章模型设计">文章模型设计</a>
            </h3>
            
            <p class="post-count animated fadeInDown">
                
                <span>
                    <b class="iconfont icon-text2"></b> <i>文章字数</i>
                    51k
                </span>
                
                
                <span>
                    <b class="iconfont icon-timer__s"></b> <i>阅读约需</i>
                    47 mins.
                </span>
                
                
                
                <span id="busuanzi_container_page_pv">
                    <b class="iconfont icon-read"></b> <i>阅读次数</i>
                    <span id="busuanzi_value_page_pv">0</span>
                </span>
                
            </p>
            
            
        </div>
    </div>
</div>

<div class="screen-gradient-after">
    <div class="screen-gradient-content">
        <div class="screen-gradient-content-inside">
            <div class="bold-underline-links screen-gradient-sponsor">
                <p>
                    <span class="animated fadeIn delay-1s"></span>
                </p>
            </div>
        </div>
    </div>
</div>

<div class="article">
    <div class='main'>
        <div class="content markdown animated fadeIn">
            <h2 id="4-9-1-文章模型设计"><a href="#4-9-1-文章模型设计" class="headerlink" title="4.9.1 文章模型设计"></a>4.9.1 文章模型设计</h2><p>我们只存储文章的作者 id、标题、正文和点击量这几个字段，对应修改 lib/mongo.js，添加如下代码：</p>
<p><strong>lib/mongo.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">exports.Post = mongolass.model(<span class="string">'Post'</span>, &#123;</span><br><span class="line">  author: &#123; <span class="attr">type</span>: Mongolass.Types.ObjectId, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  title: &#123; <span class="attr">type</span>: <span class="string">'string'</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  content: &#123; <span class="attr">type</span>: <span class="string">'string'</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  pv: &#123; <span class="attr">type</span>: <span class="string">'number'</span>, <span class="attr">default</span>: <span class="number">0</span> &#125;</span><br><span class="line">&#125;)</span><br><span class="line">exports.Post.index(&#123; <span class="attr">author</span>: <span class="number">1</span>, <span class="attr">_id</span>: <span class="number">-1</span> &#125;).exec()<span class="comment">// 按创建时间降序查看用户的文章列表</span></span><br></pre></td></tr></table></figure>

<h2 id="4-9-2-发表文章"><a href="#4-9-2-发表文章" class="headerlink" title="4.9.2 发表文章"></a>4.9.2 发表文章</h2><p>现在我们来实现发表文章的功能。首先创建发表文章页，新建 views/create.ejs，添加如下代码：</p>
<p><strong>views/create.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include(&apos;header&apos;) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;ui grid&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;four wide column&quot;&gt;</span><br><span class="line">    &lt;a class=&quot;avatar avatar-link&quot;</span><br><span class="line">       href=&quot;/posts?author=&lt;%= user._id %&gt;&quot;</span><br><span class="line">       data-title=&quot;&lt;%= user.name %&gt; | &lt;%= (&#123;m: &apos;男&apos;, f: &apos;女&apos;, x: &apos;保密&apos;&#125;)[user.gender] %&gt;&quot;</span><br><span class="line">       data-content=&quot;&lt;%= user.bio %&gt;&quot;&gt;</span><br><span class="line">      &lt;img class=&quot;avatar&quot; src=&quot;/img/&lt;%= user.avatar %&gt;&quot;&gt;</span><br><span class="line">    &lt;/a&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;eight wide column&quot;&gt;</span><br><span class="line">    &lt;form class=&quot;ui form segment&quot; method=&quot;post&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;field required&quot;&gt;</span><br><span class="line">        &lt;label&gt;标题&lt;/label&gt;</span><br><span class="line">        &lt;input type=&quot;text&quot; name=&quot;title&quot;&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;field required&quot;&gt;</span><br><span class="line">        &lt;label&gt;内容&lt;/label&gt;</span><br><span class="line">        &lt;textarea name=&quot;content&quot; rows=&quot;15&quot;&gt;&lt;/textarea&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;input type=&quot;submit&quot; class=&quot;ui button&quot; value=&quot;发布&quot;&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;%- include(&apos;footer&apos;) %&gt;</span><br></pre></td></tr></table></figure>

<p>修改 routes/posts.js，将：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET /posts/create 发表文章页</span></span><br><span class="line">router.get(<span class="string">'/create'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'发表文章页'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET /posts/create 发表文章页</span></span><br><span class="line">router.get(<span class="string">'/create'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'create'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>登录成功状态，点击右上角『发表文章』试下吧。</p>
<p>发表文章页已经完成了，接下来新建 models/posts.js 用来存放与文章操作相关的代码：</p>
<p><strong>models/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Post = <span class="built_in">require</span>(<span class="string">'../lib/mongo'</span>).Post</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 创建一篇文章</span></span><br><span class="line">  create: <span class="function"><span class="keyword">function</span> <span class="title">create</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Post.create(post).exec()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改 routes/posts.js，在文件上方引入 PostModel：</p>
<p><strong>routes/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PostModel = <span class="built_in">require</span>(<span class="string">'../models/posts'</span>)</span><br></pre></td></tr></table></figure>

<p>将：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// POST /posts/create 发表一篇文章</span></span><br><span class="line">router.post(<span class="string">'/create'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'发表文章'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// POST /posts/create 发表一篇文章</span></span><br><span class="line">router.post(<span class="string">'/create'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> author = req.session.user._id</span><br><span class="line">  <span class="keyword">const</span> title = req.fields.title</span><br><span class="line">  <span class="keyword">const</span> content = req.fields.content</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 校验参数</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!title.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'请填写标题'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!content.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'请填写内容'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    req.flash(<span class="string">'error'</span>, e.message)</span><br><span class="line">    <span class="keyword">return</span> res.redirect(<span class="string">'back'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> post = &#123;</span><br><span class="line">    author: author,</span><br><span class="line">    title: title,</span><br><span class="line">    content: content</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  PostModel.create(post)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 此 post 是插入 mongodb 后的值，包含 _id</span></span><br><span class="line">      post = result.ops[<span class="number">0</span>]</span><br><span class="line">      req.flash(<span class="string">'success'</span>, <span class="string">'发表成功'</span>)</span><br><span class="line">      <span class="comment">// 发表成功后跳转到该文章页</span></span><br><span class="line">      res.redirect(<span class="string">`/posts/<span class="subst">$&#123;post._id&#125;</span>`</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(next)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这里校验了上传的表单字段，并将文章信息插入数据库，成功后跳转到该文章页并显示『发表成功』的通知，失败后请求会进入错误处理函数。</p>
<p>现在刷新页面（登录情况下），点击右上角 <code>发表文章</code> 试试吧，发表成功后跳转到了文章页但并没有任何内容，下面我们就来实现文章页及主页。</p>
<h2 id="4-9-3-主页与文章页"><a href="#4-9-3-主页与文章页" class="headerlink" title="4.9.3 主页与文章页"></a>4.9.3 主页与文章页</h2><p>现在我们来实现主页及文章页。修改 models/posts.js 如下：</p>
<p><strong>models/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> marked = <span class="built_in">require</span>(<span class="string">'marked'</span>)</span><br><span class="line"><span class="keyword">const</span> Post = <span class="built_in">require</span>(<span class="string">'../lib/mongo'</span>).Post</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 post 的 content 从 markdown 转换成 html</span></span><br><span class="line">Post.plugin(<span class="string">'contentToHtml'</span>, &#123;</span><br><span class="line">  afterFind: <span class="function"><span class="keyword">function</span> (<span class="params">posts</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> posts.map(<span class="function"><span class="keyword">function</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">      post.content = marked(post.content)</span><br><span class="line">      <span class="keyword">return</span> post</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  afterFindOne: <span class="function"><span class="keyword">function</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (post) &#123;</span><br><span class="line">      post.content = marked(post.content)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> post</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 创建一篇文章</span></span><br><span class="line">  create: <span class="function"><span class="keyword">function</span> <span class="title">create</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Post.create(post).exec()</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过文章 id 获取一篇文章</span></span><br><span class="line">  getPostById: <span class="function"><span class="keyword">function</span> <span class="title">getPostById</span> (<span class="params">postId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Post</span><br><span class="line">      .findOne(&#123; <span class="attr">_id</span>: postId &#125;)</span><br><span class="line">      .populate(&#123; <span class="attr">path</span>: <span class="string">'author'</span>, <span class="attr">model</span>: <span class="string">'User'</span> &#125;)</span><br><span class="line">      .addCreatedAt()</span><br><span class="line">      .contentToHtml()</span><br><span class="line">      .exec()</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 按创建时间降序获取所有用户文章或者某个特定用户的所有文章</span></span><br><span class="line">  getPosts: <span class="function"><span class="keyword">function</span> <span class="title">getPosts</span> (<span class="params">author</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> query = &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> (author) &#123;</span><br><span class="line">      query.author = author</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Post</span><br><span class="line">      .find(query)</span><br><span class="line">      .populate(&#123; <span class="attr">path</span>: <span class="string">'author'</span>, <span class="attr">model</span>: <span class="string">'User'</span> &#125;)</span><br><span class="line">      .sort(&#123; <span class="attr">_id</span>: <span class="number">-1</span> &#125;)</span><br><span class="line">      .addCreatedAt()</span><br><span class="line">      .contentToHtml()</span><br><span class="line">      .exec()</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过文章 id 给 pv 加 1</span></span><br><span class="line">  incPv: <span class="function"><span class="keyword">function</span> <span class="title">incPv</span> (<span class="params">postId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Post</span><br><span class="line">      .update(&#123; <span class="attr">_id</span>: postId &#125;, &#123; <span class="attr">$inc</span>: &#123; <span class="attr">pv</span>: <span class="number">1</span> &#125; &#125;)</span><br><span class="line">      .exec()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要讲解两点：</p>
<ol>
<li>我们使用了 markdown 解析文章的内容，所以在发表文章的时候可使用 markdown 语法（如插入链接、图片等等），关于 markdown 的使用请参考： <a href="http://wowubuntu.com/markdown/" target="_blank" rel="noopener">Markdown 语法说明</a>。</li>
<li>我们在 PostModel 上注册了 <code>contentToHtml</code>，而 <code>addCreatedAt</code> 是在 lib/mongo.js 中 mongolass 上注册的。也就是说 <code>contentToHtml</code> 只针对 PostModel 有效，而 <code>addCreatedAt</code> 对所有 Model 都有效。</li>
</ol>
<p>接下来完成主页的模板，修改 views/posts.ejs 如下：</p>
<p><strong>views/posts.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include(&apos;header&apos;) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;% posts.forEach(function (post) &#123; %&gt;</span><br><span class="line">  &lt;%- include(&apos;components/post-content&apos;, &#123; post: post &#125;) %&gt;</span><br><span class="line">&lt;% &#125;) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%- include(&apos;footer&apos;) %&gt;</span><br></pre></td></tr></table></figure>

<p>新建 views/components/post-content.ejs 用来存放单篇文章的模板片段：</p>
<p><strong>views/components/post-content.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;post-content&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;ui grid&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;four wide column&quot;&gt;</span><br><span class="line">      &lt;a class=&quot;avatar avatar-link&quot;</span><br><span class="line">         href=&quot;/posts?author=&lt;%= post.author._id %&gt;&quot;</span><br><span class="line">         data-title=&quot;&lt;%= post.author.name %&gt; | &lt;%= (&#123;m: &apos;男&apos;, f: &apos;女&apos;, x: &apos;保密&apos;&#125;)[post.author.gender] %&gt;&quot;</span><br><span class="line">         data-content=&quot;&lt;%= post.author.bio %&gt;&quot;&gt;</span><br><span class="line">        &lt;img class=&quot;avatar&quot; src=&quot;/img/&lt;%= post.author.avatar %&gt;&quot;&gt;</span><br><span class="line">      &lt;/a&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class=&quot;eight wide column&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;ui segment&quot;&gt;</span><br><span class="line">        &lt;h3&gt;&lt;a href=&quot;/posts/&lt;%= post._id %&gt;&quot;&gt;&lt;%= post.title %&gt;&lt;/a&gt;&lt;/h3&gt;</span><br><span class="line">        &lt;pre&gt;&lt;%- post.content %&gt;&lt;/pre&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;span class=&quot;tag&quot;&gt;&lt;%= post.created_at %&gt;&lt;/span&gt;</span><br><span class="line">          &lt;span class=&quot;tag right&quot;&gt;</span><br><span class="line">            &lt;span&gt;浏览(&lt;%= post.pv || 0 %&gt;)&lt;/span&gt;</span><br><span class="line">            &lt;span&gt;留言(&lt;%= post.commentsCount || 0 %&gt;)&lt;/span&gt;</span><br><span class="line"></span><br><span class="line">            &lt;% if (user &amp;&amp; post.author._id &amp;&amp; user._id.toString() === post.author._id.toString()) &#123; %&gt;</span><br><span class="line">              &lt;div class=&quot;ui inline dropdown&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;text&quot;&gt;&lt;/div&gt;</span><br><span class="line">                &lt;i class=&quot;dropdown icon&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;div class=&quot;menu&quot;&gt;</span><br><span class="line">                  &lt;div class=&quot;item&quot;&gt;&lt;a href=&quot;/posts/&lt;%= post._id %&gt;/edit&quot;&gt;编辑&lt;/a&gt;&lt;/div&gt;</span><br><span class="line">                  &lt;div class=&quot;item&quot;&gt;&lt;a href=&quot;/posts/&lt;%= post._id %&gt;/remove&quot;&gt;删除&lt;/a&gt;&lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">            &lt;% &#125; %&gt;</span><br><span class="line"></span><br><span class="line">          &lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：我们用了 <code>&lt;%- post.content %&gt;</code>，而不是 <code>&lt;%= post.content %&gt;</code>，因为 post.content 是 markdown 转换后的 html 字符串。</p>
</blockquote>
<p>修改 routes/posts.js，将：</p>
<p><strong>routes/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'posts'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> author = req.query.author</span><br><span class="line"></span><br><span class="line">  PostModel.getPosts(author)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">posts</span>) </span>&#123;</span><br><span class="line">      res.render(<span class="string">'posts'</span>, &#123;</span><br><span class="line">        posts: posts</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(next)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：主页与用户页通过 url 中的 author 区分。</p>
</blockquote>
<p>现在完成了主页与用户页，访问 <code>http://localhost:3000/posts</code> 试试吧，现在已经将我们之前创建的文章显示出来了，尝试点击用户的头像看看效果。</p>
<p>接下来完成文章详情页。新建 views/post.ejs，添加如下代码：</p>
<p><strong>views/post.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include(&apos;header&apos;) %&gt;</span><br><span class="line">&lt;%- include(&apos;components/post-content&apos;) %&gt;</span><br><span class="line">&lt;%- include(&apos;footer&apos;) %&gt;</span><br></pre></td></tr></table></figure>

<p>打开 routes/posts.js，将：</p>
<p><strong>routes/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET /posts/:postId 单独一篇的文章页</span></span><br><span class="line">router.get(<span class="string">'/:postId'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'文章详情页'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET /posts/:postId 单独一篇的文章页</span></span><br><span class="line">router.get(<span class="string">'/:postId'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> postId = req.params.postId</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Promise</span>.all([</span><br><span class="line">    PostModel.getPostById(postId), <span class="comment">// 获取文章信息</span></span><br><span class="line">    PostModel.incPv(postId)<span class="comment">// pv 加 1</span></span><br><span class="line">  ])</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> post = result[<span class="number">0</span>]</span><br><span class="line">      <span class="keyword">if</span> (!post) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'该文章不存在'</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      res.render(<span class="string">'post'</span>, &#123;</span><br><span class="line">        post: post</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(next)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>现在刷新浏览器，点击文章的标题看看浏览器地址的变化吧。</p>
<blockquote>
<p>注意：浏览器地址有变化，但页面看不出区别来（因为页面布局一样），后面我们添加留言功能后就能看出区别来了。</p>
</blockquote>
<h2 id="4-9-4-编辑与删除文章"><a href="#4-9-4-编辑与删除文章" class="headerlink" title="4.9.4 编辑与删除文章"></a>4.9.4 编辑与删除文章</h2><p>现在我们来完成编辑与删除文章的功能。修改 models/posts.js，在 module.exports 对象上添加如下 3 个方法：</p>
<p><strong>models/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过文章 id 获取一篇原生文章（编辑文章）</span></span><br><span class="line">getRawPostById: <span class="function"><span class="keyword">function</span> <span class="title">getRawPostById</span> (<span class="params">postId</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Post</span><br><span class="line">    .findOne(&#123; <span class="attr">_id</span>: postId &#125;)</span><br><span class="line">    .populate(&#123; <span class="attr">path</span>: <span class="string">'author'</span>, <span class="attr">model</span>: <span class="string">'User'</span> &#125;)</span><br><span class="line">    .exec()</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过文章 id 更新一篇文章</span></span><br><span class="line">updatePostById: <span class="function"><span class="keyword">function</span> <span class="title">updatePostById</span> (<span class="params">postId, data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Post.update(&#123; <span class="attr">_id</span>: postId &#125;, &#123; <span class="attr">$set</span>: data &#125;).exec()</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过文章 id 删除一篇文章</span></span><br><span class="line">delPostById: <span class="function"><span class="keyword">function</span> <span class="title">delPostById</span> (<span class="params">postId</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Post.deleteOne(&#123; <span class="attr">_id</span>: postId &#125;).exec()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：不要忘了在适当位置添加逗号，如 incPv 的结束大括号后。</p>
</blockquote>
<blockquote>
<p>注意：我们通过新函数 <code>getRawPostById</code> 用来获取文章原生的内容（编辑页面用），而不是用 <code>getPostById</code> 返回将 markdown 转换成 html 后的内容。</p>
</blockquote>
<p>新建编辑文章页 views/edit.ejs，添加如下代码：</p>
<p><strong>views/edit.ejs</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include(<span class="string">'header'</span>) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"ui grid"</span>&gt;</span><br><span class="line">  &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"four wide column"</span>&gt;</span><br><span class="line">    &lt;a <span class="class"><span class="keyword">class</span></span>=<span class="string">"avatar"</span></span><br><span class="line">       href=<span class="string">"/posts?author=&lt;%= user._id %&gt;"</span></span><br><span class="line">       data-title=<span class="string">"&lt;%= user.name %&gt; | &lt;%= (&#123;m: '男', f: '女', x: '保密'&#125;)[user.gender] %&gt;"</span></span><br><span class="line">       data-content=<span class="string">"&lt;%= user.bio %&gt;"</span>&gt;</span><br><span class="line">      &lt;img <span class="class"><span class="keyword">class</span></span>=<span class="string">"avatar"</span> src=<span class="string">"/img/&lt;%= user.avatar %&gt;"</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"eight wide column"</span>&gt;</span><br><span class="line">    &lt;form <span class="class"><span class="keyword">class</span></span>=<span class="string">"ui form segment"</span> method=<span class="string">"post"</span> action=<span class="string">"/posts/&lt;%= post._id %&gt;/edit"</span>&gt;</span><br><span class="line">      &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"field required"</span>&gt;</span><br><span class="line">        &lt;label&gt;标题&lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">        &lt;input type="text" name="title" value="&lt;%= post.title %&gt;"&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">      &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"field required"</span>&gt;</span><br><span class="line">        &lt;label&gt;内容&lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">        &lt;textarea name="content" rows="15"&gt;&lt;%= post.content %&gt;&lt;/</span>textarea&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;input type="submit" class="ui button" value="发布"&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>form&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br><span class="line"></span><br><span class="line">&lt;%- include(<span class="string">'footer'</span>) %&gt;</span><br></pre></td></tr></table></figure>

<p>修改 routes/posts.js，将：</p>
<p><strong>routes/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET /posts/:postId/edit 更新文章页</span></span><br><span class="line">router.get(<span class="string">'/:postId/edit'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'更新文章页'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST /posts/:postId/edit 更新一篇文章</span></span><br><span class="line">router.post(<span class="string">'/:postId/edit'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'更新文章'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /posts/:postId/remove 删除一篇文章</span></span><br><span class="line">router.get(<span class="string">'/:postId/remove'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'删除文章'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET /posts/:postId/edit 更新文章页</span></span><br><span class="line">router.get(<span class="string">'/:postId/edit'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> postId = req.params.postId</span><br><span class="line">  <span class="keyword">const</span> author = req.session.user._id</span><br><span class="line"></span><br><span class="line">  PostModel.getRawPostById(postId)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!post) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'该文章不存在'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (author.toString() !== post.author._id.toString()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'权限不足'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      res.render(<span class="string">'edit'</span>, &#123;</span><br><span class="line">        post: post</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(next)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST /posts/:postId/edit 更新一篇文章</span></span><br><span class="line">router.post(<span class="string">'/:postId/edit'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> postId = req.params.postId</span><br><span class="line">  <span class="keyword">const</span> author = req.session.user._id</span><br><span class="line">  <span class="keyword">const</span> title = req.fields.title</span><br><span class="line">  <span class="keyword">const</span> content = req.fields.content</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 校验参数</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!title.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'请填写标题'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!content.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'请填写内容'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    req.flash(<span class="string">'error'</span>, e.message)</span><br><span class="line">    <span class="keyword">return</span> res.redirect(<span class="string">'back'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  PostModel.getRawPostById(postId)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!post) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'文章不存在'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (post.author._id.toString() !== author.toString()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'没有权限'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      PostModel.updatePostById(postId, &#123; <span class="attr">title</span>: title, <span class="attr">content</span>: content &#125;)</span><br><span class="line">        .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          req.flash(<span class="string">'success'</span>, <span class="string">'编辑文章成功'</span>)</span><br><span class="line">          <span class="comment">// 编辑成功后跳转到上一页</span></span><br><span class="line">          res.redirect(<span class="string">`/posts/<span class="subst">$&#123;postId&#125;</span>`</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(next)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /posts/:postId/remove 删除一篇文章</span></span><br><span class="line">router.get(<span class="string">'/:postId/remove'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> postId = req.params.postId</span><br><span class="line">  <span class="keyword">const</span> author = req.session.user._id</span><br><span class="line"></span><br><span class="line">  PostModel.getRawPostById(postId)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!post) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'文章不存在'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (post.author._id.toString() !== author.toString()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'没有权限'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      PostModel.delPostById(postId)</span><br><span class="line">        .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          req.flash(<span class="string">'success'</span>, <span class="string">'删除文章成功'</span>)</span><br><span class="line">          <span class="comment">// 删除成功后跳转到主页</span></span><br><span class="line">          res.redirect(<span class="string">'/posts'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(next)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>现在刷新主页，点击文章右下角的小三角，编辑文章和删除文章试试吧。</p>
<p>上一节：<a href="https://github.com/nswbmw/N-blog/blob/master/book/4.8%20%E7%99%BB%E5%87%BA%E4%B8%8E%E7%99%BB%E5%BD%95.md" target="_blank" rel="noopener">4.8 登出与登录</a></p>
<p>下一节：<a href="https://github.com/nswbmw/N-blog/blob/master/book/4.10%20%E7%95%99%E8%A8%80.md" target="_blank" rel="noopener">4.10 留言</a></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls"
                data-autoplay="true">
                <source type="audio/mpeg" src="">
            </audio>
            
            <ul id="audio-list" style="display:none">
                
                
                <li title='0' data-url='/statics/Kenny G-Right here waiting.mp3'></li>
                
                    
            </ul>
            
            
            
    <div id='gitalk-container' class="comment link"
        data-ae='true'
        data-ci='ec894e2b66f752e8b7fb'
        data-cs='3ccc2e92bb350688fe2c2dc2930189b62622bfb1'
        data-r='blog-comments'
        data-o='FloatingRain'
        data-a='FloatingRain'
        data-d=''
    >留言</div>


            
            
        </div>
        <div class="sidebar">
            <div class="box animated fadeInRight">
                <div class="subbox">
                    <img src="https://res.cloudinary.com/tridiamond/image/upload/v1573019751/TriDiamond_logo_ui_xeublz.jpg" height=300 width=300></img>
                    <p>Floating Rain</p>
                    <span>Floating Rain Blog</span>
                    <dl>
                        <dd><a href="https://github.com/kbzxzzm" target="_blank"><span
                                    class=" iconfont icon-github"></span></a></dd>
                        <dd><a href="https://gitee.com/kbzxzzm" target="_blank"><span
                                    class=" iconfont icon-twitter"></span></a></dd>
                        <dd><a href="https://stackoverflow.com/users/12817184/flioatingrain" target="_blank"><span
                                    class=" iconfont icon-stack-overflow"></span></a></dd>
                    </dl>
                </div>
                <ul>
                    <li><a href="/">30 <p>文章</p></a></li>
                    <li><a href="/categories">2 <p>分类</p></a></li>
                    <li><a href="/tags">2 <p>标签</p></a></li>
                </ul>
            </div>
            
            
            
            <div class="box sticky animated fadeInRight faster">
                <div id="toc" class="subbox">
                    <h4>目录</h4>
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-9-1-文章模型设计"><span class="toc-number">1.</span> <span class="toc-text">4.9.1 文章模型设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-9-2-发表文章"><span class="toc-number">2.</span> <span class="toc-text">4.9.2 发表文章</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-9-3-主页与文章页"><span class="toc-number">3.</span> <span class="toc-text">4.9.3 主页与文章页</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-9-4-编辑与删除文章"><span class="toc-number">4.</span> <span class="toc-text">4.9.4 编辑与删除文章</span></a></li></ol>
                </div>
            </div>
            
            
        </div>
    </div>
</div>

    </div>
</div>
    <div id="back-to-top" class="animated fadeIn faster">
        <div class="flow"></div>
        <span class="percentage animated fadeIn faster">0%</span>
        <span class="iconfont icon-top02 animated fadeIn faster"></span>
    </div>
</body>
<footer>
    <p class="copyright" id="copyright">
        &copy; 2020
        <span class="gradient-text">
            Floating Rain
        </span>.
        Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a>
        Theme
        <span class="gradient-text">
            <a href="https://github.com/TriDiamond/hexo-theme-obsidian" title="Obsidian" target="_blank" rel="noopener">Obsidian</a>
        </span>
        <small><a href="https://github.com/TriDiamond/hexo-theme-obsidian/blob/master/CHANGELOG.md" title="v1.4.3" target="_blank" rel="noopener">v1.4.3</a></small>
    </p>
</footer>

<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script>
  MathJax.Hub.Config({
    "HTML-CSS": {
      preferredFont: "TeX",
      availableFonts: ["STIX", "TeX"],
      linebreaks: {
        automatic: true
      },
      EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
      inlineMath: [
        ["$", "$"],
        ["\\(", "\\)"]
      ],
      processEscapes: true,
      ignoreClass: "tex2jax_ignore|dno",
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      noUndefined: {
        attributes: {
          mathcolor: "red",
          mathbackground: "#FFEEEE",
          mathsize: "90%"
        }
      },
      Macros: {
        href: "{}"
      }
    },
    messageStyle: "none"
  });
</script>
<script>
  function initialMathJax() {
    MathJax.Hub.Queue(function () {
      var all = MathJax.Hub.getAllJax(),
        i;
      // console.log(all);
      for (i = 0; i < all.length; i += 1) {
        console.log(all[i].SourceElement().parentNode)
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  }

  function reprocessMathJax() {
    if (typeof MathJax !== 'undefined') {
      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    }
  }
</script>



    <link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.css">
    <script src="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/obsidian.js"></script>
<script src="/js/jquery.truncate.js"></script>
<script src="/js/search.js"></script>
<script src="//cdn.bootcss.com/typed.js/2.0.10/typed.min.js"></script>
<script src="//cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

<script src="https://cdn.bootcss.com/codemirror/5.48.4/codemirror.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/javascript/javascript.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/css/css.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/xml/xml.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/htmlmixed/htmlmixed.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/clike/clike.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/php/php.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/shell/shell.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/python/python.min.js"></script>



    <script src="/js/busuanzi.min.js"></script>
    <script>
        $(document).ready(function () {
            if ($('span[id^="busuanzi_"]').length) {
                initialBusuanzi();
            }
        });
    </script>


<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="//www.googletagmanager.com/gtag/js?id=UA-149874671-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-149874671-1');
    </script>





<script>
    function initialTyped () {
        var typedTextEl = $('.typed-text');
        if (typedTextEl && typedTextEl.length > 0) {
            var typed = new Typed('.typed-text', {
                strings: ["Floating Rain Blog", "浮  雨  个  人  博  客"],
                typeSpeed: 90,
                loop: true,
                loopCount: Infinity,
                backSpeed: 20,
            });
        }
    }

    if ($('.article-header') && $('.article-header').length) {
        $(document).ready(function () {
            initialTyped();
        });
    }
</script>




</html>
